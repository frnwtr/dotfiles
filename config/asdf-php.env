# ASDF PHP Environment Configuration
# Source this file to ensure asdf PHP takes precedence over system/Homebrew PHP
# Usage: source ~/dotfiles/config/asdf-php.env

# Ensure asdf is loaded
if [[ -f "$HOME/.asdf/asdf.sh" ]]; then
    source "$HOME/.asdf/asdf.sh"
elif [[ -f "/opt/homebrew/opt/asdf/libexec/asdf.sh" ]]; then
    source "/opt/homebrew/opt/asdf/libexec/asdf.sh"
fi

# Force asdf shims to take precedence by removing and re-adding to PATH
if [[ -d "$HOME/.asdf/shims" ]]; then
    # Remove existing asdf shims from PATH
    PATH=$(echo "$PATH" | sed "s|$HOME/.asdf/shims:||g" | sed "s|:$HOME/.asdf/shims||g")
    
    # Add asdf shims at the beginning of PATH
    export PATH="$HOME/.asdf/shims:$PATH"
fi

# PHP-specific environment variables for asdf PHP
export PHP_WITHOUT_PEAR=yes
export PHP_CONFIGURE_OPTIONS="--with-openssl=/opt/homebrew/opt/openssl@3 --with-iconv=/opt/homebrew/opt/libiconv --with-kerberos=/opt/homebrew/opt/krb5"

# Ensure proper build environment is available for future PHP builds
export PKG_CONFIG_PATH="/opt/homebrew/lib/pkgconfig:/opt/homebrew/share/pkgconfig:$PKG_CONFIG_PATH"
export LDFLAGS="-L/opt/homebrew/lib -L/opt/homebrew/opt/openssl@3/lib -L/opt/homebrew/opt/icu4c/lib -L/opt/homebrew/opt/libedit/lib -L/opt/homebrew/opt/bison/lib -L/opt/homebrew/opt/libiconv/lib -L/opt/homebrew/opt/krb5/lib $LDFLAGS"
export CPPFLAGS="-I/opt/homebrew/include -I/opt/homebrew/opt/openssl@3/include -I/opt/homebrew/opt/icu4c/include -I/opt/homebrew/opt/libedit/include -I/opt/homebrew/opt/bison/include -I/opt/homebrew/opt/libiconv/include -I/opt/homebrew/opt/krb5/include $CPPFLAGS"

# PHP CLI configuration for better performance
export PHP_CLI_SERVER_WORKERS=4

# Clear any conflicting PHP configuration directory settings from Homebrew PHP
# This prevents asdf PHP from scanning Homebrew PHP configuration files
unset PHP_INI_SCAN_DIR

# Set the correct PHP INI scan directory for asdf PHP
if command -v php >/dev/null 2>&1 && [[ "$(which php)" == *".asdf/shims/php" ]]; then
    ASDF_PHP_VERSION=$(asdf current php 2>/dev/null | awk '{print $2}' || echo "8.3.16")
    if [[ -d "$HOME/.asdf/installs/php/$ASDF_PHP_VERSION/etc/php.conf.d" ]]; then
        export PHP_INI_SCAN_DIR="$HOME/.asdf/installs/php/$ASDF_PHP_VERSION/etc/php.conf.d"
    fi
fi

echo "âœ“ ASDF PHP environment loaded"
echo "  PHP Path: $(which php)"
echo "  PHP Version: $(php --version | head -1 2>/dev/null || echo 'PHP version check failed')"
echo "  Composer Path: $(which composer)"
